~~~~~~~~~~~~~~~~~
ExtPerso services
~~~~~~~~~~~~~~~~~

172.19.12.110:   C:\apps\perso     ID=0
172.19.9.69:     C:\apps\perso     ID=1     (почта + выход в Интернет)

SRC: LAPTOP-WORK (123), E:\Projects\scripts\perso

Архитектура программного кода:
------------------------------

app : ядро
ext : расширения (бизнес-логика)

Исполняемые файлы (Python-сборки, pyinstaller, setup-ы):

persoService.exe - Windows-сервис
run.exe - однократный "ручной" модуль

Настройка сценариев выполняются в py-файлах внутри ext. Ядро без необходимости трогать не надо.

Файлы определений в ядре, основные:

types\*.*:

actions.py      - операции
constants.py    - системные константы
datatypes.py    - типы данных
encodings.py    - типы кодировок
errors.py       - ошибки
filetypes.py    - типы форматов файлов
routes.py       - маршруты (не используется)
statuses.py     - статусы

Структура кода расширений:
==========================
defaults        - определения по умолчанию (константы)
filetypes       - типы файлов - основные определения логики персофайлов клиента

Прикладные модули:
------------------
loader              - загрузчик входящий файлов и справочников
order_check         - модуль контроля входящих данных
order_generate      - модуль генерации данных
order_merge         - сборщик файлов
order_report        - модуль генерации отчетов
preloader           - предобработчик
unloader            - модуль доп.выгрузки данных

ext\__init__.py     - корневой (глобальный) сценарий (global_scenario, filetypes_modules, ext_modules)
ext\postonline.py   - модуль обслуживания в ПАО "ПОЧТА РОССИИ"
ext\xmllib.py       - библиотека локальных функций XML, в дополнение к app\xmllib.py

Схема построения настроек:
--------------------------

Глобальный сценарий (ext\__init__.py)
 |
Тип файла FILETYPE (ext\filetypes\*.py)
 |
МОДУЛЬ (ext\<module>)
 |
СЦЕНАРИЙ или МАРШРУТ (ext\<module>\__init__.py)
 |
БИЗНЕС-ЛОГИКА (ext\<module>\*.py)


Настройки ПОЧТАБАНКА:
---------------------

Регистр Типов файла: ext\filetypes\__init__.py, registered_order_filetypes - список активных Типов файла.

Модуль декларации Типа файла: ext\filetypes\postbank.py

Это основной файл, в котором содержатся основные определения, форматы, константы, функции, используемые в логике сценария банка.

Среди них:

FILETYPE_POSTBANK_TEMPLATE  - Дескриптор-шаблон форматов входящих файлов

FILETYPE_POSTBANK_V1        - Тип файла PostBank_v1 (все текущие файлы, кроде ИД)

FILETYPE_POSTBANK_ID        - Тип файла PostBank_ID (индивидуальный дизайн)

FILETYPE_POSTBANK_REFERENCE - справочник филиалов банка

и набор функций в теле файла (см. комментарии в коде).


Операции, которые могут потребоваться в первую очередь:
=======================================================

-----------------------------------------------------------------------------------------------
Сменить дату отгрузки персофайла: ext\order_generate\postbank.py, postbank.change_delivery_date
-----------------------------------------------------------------------------------------------

Выполняется в следующей последовательности:

1) Останавливаем сервис ExtPerso ID=1: 

    # c:\apps\perso\stop.bat

2) В сценарии ext\order_generate\__init__.py копируем кортеж (элемент сценария) вверх (активируем):

    (1, 'PostBank_v1',
        [21, 0,],
        {
            'tags'   : everything,
            'custom' : postbank.change_delivery_date,
            'params' : {'date' : '16.05.2019'},
            'forced' : 296750,

            'change_status' : 0,
        },
    ),

3) Кодируем текущий статус файла! (вместо 21), FileID в параметре 'forced' и актуальную дату отгрузки в параметре 'params' (словарь, ключ 'date').

Больше ничего трогать не надо. Важно 'change_status' = 0 - не производить смену статуса.

4) Выполняем (однократно):

    # c:\apps\perso\run.bat

*************************************************************************************************************************************

ПРИМЕЧАНИЕ! 
-----------
Исполняемый файл C:\apps\perso\persoService.exe - это сервис (Windows-служба) - постоянный процесс, периодически выполняющий заданный
сценарий. Одноразовые операции выполнять при помощи сервиса нельзя!

Для разовых операций применяется модуль C:\apps\perso\run.exe. Выполняем одноименным bat-файлом из п.5)

*************************************************************************************************************************************

5) Проверяем в интерфейсе WebPerso:

    - поле "Дата отгрузки" в Журнале заказов БанкПерсо
    - лог : "Файловый журнал"
    - контент IBODY, тег <DeliveryDate>

6) Удаляем (убираем) блок добавленный в п.2 (Не забывать!) перед стартом сервиса.

7) Стартуем сервис ExtPerso ID=1:

    # c:\apps\perso\start.bat


Для проверки текущего состояния сервиса используется локальная консоль, файл:

    C:\apps\perso\console
    
В консоли можно выполнить команду, для чего открываем файл "на редактирование" и в строке последнего приглашения вводим код команды:

    Command: {{a|m|e}[N]|r|s|u|q} --> s
    
например: <s> - отобразить текущий статус сервиса.

Сразу после ввода команды, файл в редакторе, например, в Far-е (F4), закрываем и открываем "на чтение" (F3).

Ответ сервиса:

    2019-04-22 12:04:14 $ Status: running...

Список команд:

    a - отобразить все сообщения прикладных модулей, выполненных за истекший период
    m - отобразить сообщения с кодом завершения "успешно"
    e - отобразить ошибки
    r - выполнить полный рестарт сервиса
    s - отобразить текущий статус сервиса
    u - выполнить update - обновить параметры конфигуратора perso.config.default
    q - закрыть консоль

    N - количество выводимых сообщений: целое число.

Например:

    a100 - вывести 100 последних сообщений
    e    - вывести ошибки
    u    - обновить конфигуратор

Закрывать консоль <q> без нужды не надо.

****************************************************

ПРИМЕЧАНИЕ! 
-----------
Если ответа от сервиса нет - приложение не работает.

****************************************************

-----------------------------------------------------------------------------------------------------
Перерегистрировать отгрузку в ПочтаРоссии: ext\order_generate\postbank.py, postbank.custom_postonline
-----------------------------------------------------------------------------------------------------

1) Останавливаем сервис ExtPerso ID=1: 

    # c:\apps\perso\stop.bat

2) В сценарии ext\order_generate\__init__.py копируем кортеж (элемент сценария) вверх (активируем):

    (1, 'PostBank_v1',  
        [21, 0],
        {
            'tags'   : everything,
            'custom' : postbank.custom_postonline,
            'phases' : 2,
            'forced' : 287884,

            'change_status' : 0,
        },
    ),

3) Кодируем текущий статус файла, FileID в параметре 'forced'.

4) Выполняем (однократно):

    # c:\apps\perso\run.bat

5) Проверяем:

    - контент IBODY, теги <PostOrderID>, <PostBarcode>, <PostRate>, <PostOnlineBatches>
    - лог : "Файловый журнал"
    
[172.19.9.69] C:/!Pers2.1/Bin/Log_ExtPerso/20190422_ExtPerso.log
2019-04-22 09:08:30	INFO	PostOnline OK: VBEX_CRDEMB_20190419_005_20190423$PI.TXT, phase[0], созданы почтовые отправления: C1-A1:755

а так же - в сервисе с сайта:

    https://otpravka.pochta.ru/dashboard#/dispatch
    
с аналогичным кодом отправления 755.

6) Удаляем (убираем) блок, добавленный в п.2 (Не забывать!), перед стартом сервиса.

7) Стартуем сервис ExtPerso ID=1:

    # c:\apps\perso\start.bat

---------------------------------------------------------------------------------------------
Отправить Ф103-архив в ОПС: ext\order_generate\postbank.py, postbank.custom_postonline_sender
---------------------------------------------------------------------------------------------

1) stop.bat

2) Добавляем операцию:

    (1, 'PostBank_v1',  
        [198, 0],
        {
            'tags'   : processinfo,
            'custom' : postbank.custom_postonline_sender,
            'forced' : 287884,

            'change_status' : 0,
        },
    ),

3) Кодируем текущий статус файла, FileID в forced.

4) run.bat

5) Проверяем:

    - лог : "Файловый журнал"

2019-04-22 09:08:30	INFO	PostOnline Email[VBEX_CRDEMB_20190419_005_20190423$PI.TXT]: ПОЧТА БАНК F103:755 to f103ops-102961@russianpost.ru;webdev@rosan.ru

6) Удаляем операцию.

7) start.bat

*********************************************************************************

ПРИМЕЧАНИЕ! 
-----------
Все операции рекомендуется выполнять в консоли cmd с полномочиями администратора.
По большому счету ничего сложного нет. Но это Python. Нужно быть внимательным.

*********************************************************************************


Регистрацию отправлений в ПочтеРоссии можно выполнять разными способами в зависимости от ситуации:

1) Из WebPerso: меняем текущий статус -> 46 "выполнена дополнительная генерация данных(BANKCHIP)" командой:

    Shift-F, с сохранением истории 
    
история - это предыдущие статусы, по умолчанию статусы с большими номерами (StatusID) удаляются, тогда теряем статус 99 - исходный, не стоит.

2) Через run.bat, выполнить нужно группу операций (все 3 описанных операции, последовательно):

    - Сменить дату отгрузки персофайла
    - Перерегистрировать отгрузку в ПочтаРоссии
    - Отправить Ф103-архив в ОПС

3) Перерегистрировать с сайта, как описано ниже.


-----------------------------------------------------------------
Перерегистрировать отправления ПОЧТА РОССИИ на более позднюю дату
-----------------------------------------------------------------

Выполняется с сайта:
https://otpravka.pochta.ru/dashboard#/dispatch

Учетная запись - Елена Вагнер: pmmos@rosan.ru:!qUeen-PR, отдельно ПОСЫЛКИ и ЗАКАЗНЫЕ ПИСЬМА.

1) Сменить дату файла с выгрузкой архива и отправкой в ОПС (выполняется одной командой, прямо в интерфейсе).

2) Распаковать полученный архив, например:

    doc_20190422_746_00008.zip
    
3) Скопировать файлы из архива на сервер ОТК:

    \\172.19.12.4\BankApplicationsOTK\!Pers2.0\PersoStation\Inkass\InputData\PostBank\postonline\20190423\doc_20190422_746_00008:
    
    EXPORT.csv
    EXPORT.xls
    F003232005484911200008.zip
    F103.pdf
    F7.pdf

4) ОТК печатает Форму 103 из pdf, zip отсылается в отделение ПР.


В ext можно выполнить любую работу с файлом, например: исправить контент IBODY, добавить/удалить теги, выгрузить отчеты (в инфообмен и почтой) и т.д.

Процедуры, которые используя я для этих целей:

ext\order_generate:
-------------------
postbank.checker
postbank.restart_perso
postbank.restart_inc_cards

ext\order_report:
-----------------
postbank.delivery_report
postbank.post_report

ext\unloader:
-------------
postbank.sort_report


И т.д. все наш вкус, по мере необходимости.

Описать все я не могу, не реально. Это должна быть документация. Но мы работаем по правилу - "нет документации лучше исходного кода".

Основные комментарии там есть.


Настройки (состояние файлов) на 2-х рабочих серверах совпадают, за исключением файлов:

C:\apps\perso\perso.config.default - конфигуратор приложения

Тут разные прикладные параметры (комментируются):

# PostBank merge interval
postbank_merge     :: 12:00-12:15
# Каталог выгрузки документов по отправлениям Почта России
postbank_unload_to :: //172.19.12.4/BankApplicationsOTK/!Pers2.0/PersoStation/Inkass/InputData/PostBank/postonline
# Почта России F103
pochta_mail_to     :: f103ops-102961@russianpost.ru;webdev@rosan.ru
# ПОЧТАБАНК отгрузка
postbank_mail_to   :: skorinaao@pochtabank.ru;barannikna@pochtabank.ru;avdeevaav@pochtabank.ru;kuznetsovana@pochtabank.ru; matyushenkoaa@pochtabank.ru;webdev@rosan.ru
# Накладные Розан
delivery_mail_to   :: dhperso@rosan.ru;pmmos@rosan.ru;webdev@rosan.ru
# Время активации отгрузки
postbank_active    :: 01:00-18:30

Но надо понимать, что и где работает.

C:\apps\perso\ext\__init__.py - глобальный сценарий (не все модули работают на серверах):

9.69 ID=1
---------
global_scenario = [
    #'preloader',
    #'loader',
    #'unloader',
    #'order_check',
    'order_generate',
    #'order_merge',
    'order_report',
]

12.110 ID=0
-----------
global_scenario = [
    'preloader',
    'loader',
    'unloader',
    'order_check',
    'order_generate',
    'order_merge',
    'order_report',
]


Кроме ПОЧТАБАНКА, в настройках есть Открытие, БинБанк, MinB, КОСМОС, Долинск. Но они не работают, только в качестве тестов.
